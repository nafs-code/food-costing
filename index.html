<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>حساب تكاليف المواد الغذائية</title>

<script>
  (function(){
    // غيّر كلمة السر هنا
    const PASSWORD = "nafs2025";

    // لا تضع الكود في مكان عام لو يهمك الأمان الحقيقي
    if (!sessionStorage.getItem('auth-ok')) {
      // إظهار نافذة إدخال كلمة السر
      const p = prompt("ادخل كلمة السر للوصول إلى الموقع:");
      if (p !== PASSWORD) {
        alert("كلمة السر خاطئة. سيتم تحويلك.");
        // توجيه لمكان آخر أو اغلاق
        window.location.href = "about:blank";
        return;
      } else {
        sessionStorage.setItem('auth-ok','1');
      }
    }
    // لو نجح، يُسمح بتحميل الصفحة كالمعتاد
  })();
</script>


<style>
  :root{
    --bg:#ffffff; --panel:#ffffff; --muted:#9aa5b1; --line:#1f2937;
    --ring:#3b82f6; --text:#070606; --accent:#0d6efd; --danger:#ef4444; --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic","Noto Sans Arabic",Arial,sans-serif;line-height:1.6}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between;margin:16px 0 10px;flex-wrap:wrap}
  .title{font-weight:900;font-size:clamp(20px,4vw,28px);color:var(--text)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button,select,input{border-radius:10px;border:1px solid var(--line);background:#e5e7eb;color:var(--text);padding:10px 12px;outline:none}
  button.primary{background:var(--accent);color:#fefeff;font-weight:900;border:0}
  button.danger{background:var(--danger);border:0;color:#fefeff}
  button:focus,select:focus,input:focus,textarea:focus{box-shadow:0 0 0 3px #0b57ef;border-color:var(--ring)}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 24px #fcfdfd;padding:16px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:center;vertical-align:middle}
  th{font-weight:800;color:#0b57ef}
  td img{width:60px;height:60px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#0b1020}
  td input[type="number"]{width:110px}
  .thumb-uploader{display:flex;align-items:center;gap:8px;justify-content:center}
  .thumb-uploader input{display:none}
  .thumb-btn{padding:6px 10px;border:1px dashed #334155;background:#0b57ef;border-radius:8px;cursor:pointer;font-size:12px;color:#e5e7eb}
  .totals{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
  @media (max-width:700px){.totals{grid-template-columns:1fr} td input[type="number"]{width:90px}}
  .totals .box{background:#e9eaeb;border:1px solid var(--line);padding:12px;border-radius:12px}
  .totals .row{display:grid;grid-template-columns:1fr 120px;gap:8px;align-items:center;margin:6px 0}
  .sum{font-size:18px;font-weight:900;color:#0b1020}
  footer{background:#e9eaeb;border:1px solid var(--line);border-radius:var(--radius);margin:18px 0;padding:10px 14px;text-align:center;color:#0b1020;font-size:13px}
  .lang{display:inline-flex;border:1px solid var(--line);overflow:hidden;border-radius:999px}
  .lang button{background:#0b57ef;border:0;padding:8px 20px;cursor:pointer;color:#f8f9fb}
  .lang button.active{background:#0b57ef}
  .muted{color:#237ce9}
  .note{font-size:12px;color:#ef4444;margin-top:6px}

  /* قائمة الصفحات */
  .pages-wrap{position:relative}
  .pages-btn{background:#f3f4f6}
  .pages-dd{position:absolute;top:100%;inset-inline-end:0;z-index:20;background:#fff;border:1px solid var(--line);border-radius:12px;min-width:240px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:8px;display:none}
  .pages-dd.open{display:block}
  .pages-list{list-style:none;margin:0;padding:0;max-height:260px;overflow:auto}
  .pages-list li{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;margin:6px 0;cursor:pointer}
  .pages-list li.active{border-color:#2563eb;background:#eff6ff}
  .pages-actions{display:flex;gap:8px;margin-top:8px}

  /* سطر اسم الصفحة + الزر */
  .page-row{display:flex;align-items:center;gap:8px}
  #activePageName{font-weight:700}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title" id="appTitle">حساب تكاليف المواد الغذائية</div>

      <!-- اسم الصفحة الحالية ثم زر قائمة الصفحات (حسب طلبك) -->
      <div class="page-row">
        <span id="activePageName" class="muted"></span>
        <div class="pages-wrap">
          <button id="pagesBtn" class="pages-btn">قائمة الصفحات ▾</button>
          <div id="pagesDD" class="pages-dd" role="menu" aria-hidden="true">
            <div class="muted" id="pagesHint" style="margin:4px 6px">اختر صفحة أو أنشئ صفحة جديدة</div>
            <ul id="pagesList" class="pages-list"></ul>
            <div class="pages-actions">
              <button id="pageAdd" class="primary">+ صفحة جديدة</button>
              <button id="pageRename">إعادة تسمية</button>
              <!-- زر حذف الصفحة (مضاف فقط) -->
              <button id="pageDelete" class="danger">حذف الصفحة</button>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="lang" id="langSwitch">
          <button data-lang="ar" class="active">العربية</button>
          <button data-lang="en">English</button>
        </div>
        <select id="currency">
          <option value="USD">$ USD</option>
          <option value="LBP">ل.ل LBP</option>
        </select>
        <button class="primary" id="addRow">+ إضافة صنف</button>
        <button id="exportJSON" class="primary" style="background:#2563eb">تصدير JSON</button>
        <button id="importJSON" class="primary" style="background:#2563eb">استيراد JSON</button>
        <input type="file" id="jsonFile" accept=".json" style="display:none">
        <button id="clearAll" class="danger">مسح الكل</button>
      </div>
    </header>

    <section class="panel">
      <div class="muted" id="hint">أضِف أصنافًا، اختر صورة، حدّد السعر والكمية المستخدمة — سيُحسب الإجمالي تلقائيًا.</div>
      <div class="note" id="persistNote">يتم حفظ كل شيء تلقائيًا على جهازك (LocalStorage) بشكل دائم — الحذف يدوي فقط. ثابت التحويل: 1 USD = 90000 LBP.</div>

      <div style="overflow:auto;margin-top:10px">
        <table id="itemsTable">
          <thead>
            <tr>
              <th id="thImg">صورة</th>
              <th id="thName">الاسم</th>
              <th id="thUnit">الوحدة</th>
              <th id="thPrice">السعر للوحدة</th>
              <th id="thQty">الكمية المستخدمة</th>
              <th id="thSub">الإجمالي</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="totals">
        <div class="box">
          <div class="row"><div id="sumLabel">المجموع</div><div class="sum" id="sumVal">0</div></div>
          <div class="row">
            <label for="discount" id="discountLabel">خصم %</label>
            <input id="discount" type="number" min="0" step="0.01" value="0">
          </div>
        </div>
        <div class="box">
          <div class="row">
            <label for="delivery" id="deliveryLabel">التوصيل</label>
            <input id="delivery" type="number" min="0" step="0.01" value="0">
          </div>
          <div class="row"><div id="grandLabel">الإجمالي النهائي</div><div class="sum" id="grandVal">0</div></div>
        </div>
      </div>
    </section>

    <footer>© <span id="year"></span> — <span id="footerNote">صفحة ثابتة بدون بناء أو خوادم</span></footer>
  </div>

<script>
(function(){
  const $  = (sel, root=document)=>root.querySelector(sel);
  const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

  const els = {
    tbody: $("#tbody"),
    addRow: $("#addRow"),
    sumVal: $("#sumVal"),
    grandVal: $("#grandVal"),
    delivery: $("#delivery"),
    discount: $("#discount"),
    currency: $("#currency"),
    exportJSON: $("#exportJSON"),
    importJSON: $("#importJSON"),
    jsonFile: $("#jsonFile"),
    clearAll: $("#clearAll"),
    langSwitch: $("#langSwitch"),

    // صفحات
    pagesBtn: $("#pagesBtn"),
    pagesDD: $("#pagesDD"),
    pagesList: $("#pagesList"),
    pageAdd: $("#pageAdd"),
    pageRename: $("#pageRename"),
    pageDelete: $("#pageDelete"),  // ← مضاف
    pagesHint: $("#pagesHint"),
    pageName: $("#activePageName"), // ← مضاف
  };

  // أسعار صرف ثابتة
  const RATES = { USD: 1, LBP: 90000 };

  const texts = {
    ar:{dir:"rtl", appTitle:"حساب تكاليف المواد الغذائية",
        hint:"أضِف أصنافًا، اختر صورة، حدّد السعر والكمية المستخدمة — سيُحسب الإجمالي تلقائيًا.",
        persistNote:"يتم حفظ كل شيء تلقائيًا على جهازك (LocalStorage) بشكل دائم — الحذف يدوي فقط.",
        thImg:"صورة", thName:"الاسم", thUnit:"الوحدة", thPrice:"السعر للوحدة", thQty:"الكمية المستخدمة", thSub:"الإجمالي",
        phName:"اسم الصنف", phUnit:"كغ / علبة / كرتونة ...", phPrice:"0.00", phQty:"الكمية المستخدمة",
        sumLabel:"المجموع", discountLabel:"خصم %", deliveryLabel:"التوصيل", grandLabel:"الإجمالي النهائي",
        remove:"حذف", addPhoto:"صورة", footer:"صفحة ثابتة بدون بناء أو خوادم",
        jsonExport:"تصدير JSON", jsonImport:"استيراد JSON", addItem:"+ إضافة صنف", clearAll:"مسح الكل",
        pagesBtn:"قائمة الصفحات ▾", pagesHint:"اختر صفحة أو أنشئ صفحة جديدة", pageNew:"+ صفحة جديدة", rename:"إعادة تسمية",
        deletePage:"حذف الصفحة",                        /* ← مضاف */
        confirmDelete:"سيتم حذف هذه الصفحة نهائيًا. متابعة؟", /* ← مضاف */
        promptNew:"اسم الصفحة الجديدة؟", promptRename:"اسم جديد للصفحة:", cannotRename:"لا توجد صفحة حالية!"
    },
    en:{dir:"ltr", appTitle:"Food Costing Sheet",
        hint:"Add items, choose a photo, set unit price & used quantity — totals update automatically.",
        persistNote:"Everything is saved locally on your device (LocalStorage). Deletion is manual only.",
        thImg:"Image", thName:"Name", thUnit:"Unit", thPrice:"Unit Price", thQty:"Used Qty", thSub:"Subtotal",
        phName:"Item name", phUnit:"kg / box / pack ...", phPrice:"0.00", phQty:"Used quantity",
        sumLabel:"Subtotal", discountLabel:"Discount %", deliveryLabel:"Delivery", grandLabel:"Grand Total",
        remove:"Remove", addPhoto:"Photo", footer:"Static page — no build or servers",
        jsonExport:"Export JSON", jsonImport:"Import JSON", addItem:"+ Add Item", clearAll:"Clear All",
        pagesBtn:"Pages ▾", pagesHint:"Pick a page or create one", pageNew:"+ New page", rename:"Rename",
        deletePage:"Delete page",                         /* ← مضاف */
        confirmDelete:"This page will be permanently deleted. Continue?", /* ← مضاف */
        promptNew:"New page name?", promptRename:"New name for the page:", cannotRename:"No active page!"
    }
  };

  /*---------------- مدير الصفحات (workspaces) ---------------*/
  const PAGES_META_KEY = "fc_pages";               // {activeId, list:[{id,name}]}
  const STATE_KEY = (id)=> `food_costing_state__${id}`;
  let currentPageId = null;

  function defState(){ return { items:[], delivery:0, discount:0, currency:'USD', lang:'ar' }; }

  function genId(){ return Math.random().toString(36).slice(2,10); }

  function getMeta(){
    try{ return JSON.parse(localStorage.getItem(PAGES_META_KEY)||""); }catch{ return null; }
  }
  function saveMeta(m){ localStorage.setItem(PAGES_META_KEY, JSON.stringify(m)); }

  function ensureMeta(){
    let m = getMeta();
    if(!m || !Array.isArray(m.list) || !m.list.length){
      const id = genId();
      m = {activeId:id, list:[{id, name:"الصفحة 1"}]};
      localStorage.setItem(STATE_KEY(id), JSON.stringify(defState()));
      saveMeta(m);
    }
    return m;
  }

  function setHash(id){
    const u = new URL(location.href); u.hash = `#p=${id}`; history.replaceState(null,"",u);
  }

  function renderPagesDD(){
    const m = ensureMeta();
    els.pagesList.innerHTML = "";
    m.list.forEach(p=>{
      const li = document.createElement('li');
      li.textContent = p.name;
      if(p.id===m.activeId) li.classList.add('active');
      li.addEventListener('click', ()=> switchPage(p.id));
      els.pagesList.appendChild(li);
    });
  }

  // اسم الصفحة الحالية
  function setActivePageName(){
    const m = ensureMeta();
    const p = m.list.find(x=>x.id===m.activeId);
    if (els.pageName) els.pageName.textContent = p ? p.name : '';
  }

  function switchPage(id){
    const m = ensureMeta();
    if(!m.list.some(p=>p.id===id)) return;
    m.activeId = id; saveMeta(m);
    currentPageId = id; setHash(id); renderPagesDD();
    setActivePageName();                 // تحديث الاسم
    loadState(); // يعيد رسم الجدول وكل شيء
    closeDD();
  }

  function openDD(){ els.pagesDD.classList.add('open'); els.pagesDD.setAttribute('aria-hidden','false'); }
  function closeDD(){ els.pagesDD.classList.remove('open'); els.pagesDD.setAttribute('aria-hidden','true'); }
  function toggleDD(){ els.pagesDD.classList.toggle('open'); }

  function addPage(){
    const lang = state?.lang || 'ar';
    const name = prompt(texts[lang].promptNew);
    if(!name) return;
    const id = genId();
    const m = ensureMeta();
    m.list.push({id, name}); m.activeId = id; saveMeta(m);
    localStorage.setItem(STATE_KEY(id), JSON.stringify(defState()));
    renderPagesDD(); switchPage(id);
  }

  function renamePage(){
    const lang = state?.lang || 'ar';
    const m = ensureMeta(); if(!m.activeId){ alert(texts[lang].cannotRename); return; }
    const page = m.list.find(p=>p.id===m.activeId);
    const name = prompt(texts[lang].promptRename, page.name); if(!name) return;
    page.name = name; saveMeta(m); renderPagesDD();
    setActivePageName();                 // اسم الصفحة بعد التسمية
  }

  // حذف الصفحة (مضاف فقط)
  function deletePage(){
    const lang = state?.lang || 'ar';
    const m = ensureMeta();
    if(!m.activeId) return;

    if(!confirm(texts[lang].confirmDelete)) return;

    const delId = m.activeId;
    // احذف حالة الصفحة من التخزين
    try{ localStorage.removeItem(STATE_KEY(delId)); }catch{}

    // أزل الصفحة من القائمة
    m.list = m.list.filter(p=>p.id!==delId);

    // إن لم تبقَ صفحات، أنشئ واحدة افتراضية
    if(m.list.length===0){
      const newId = genId();
      m.list.push({id:newId, name: (lang==='ar'?'الصفحة 1':'Page 1')} );
      localStorage.setItem(STATE_KEY(newId), JSON.stringify(defState()));
      m.activeId = newId;
    }else{
      // اختر أول صفحة متبقية كفعالة
      m.activeId = m.list[0].id;
    }

    saveMeta(m);

    // حدّث المؤشرات والواجهة
    currentPageId = m.activeId;
    setHash(currentPageId);
    renderPagesDD();
    setActivePageName();
    loadState();
    closeDD();
  }

  /*---------------- منطق الصفحة الأساسية ----------------*/
  let state = defState();

  const uid = ()=> Math.random().toString(36).slice(2);
  const isNum = v => typeof v === "number" && Number.isFinite(v);

  function formatMoney(x){
    const c = state.currency;
    const v = isNum(x) ? x : 0;
    const locale = (c==='LBP' ? 'ar-LB' : (state.lang==='ar'?'ar' : 'en-US'));
    return new Intl.NumberFormat(locale, {style:'currency', currency:c, maximumFractionDigits:2}).format(v);
  }

  function save(){ if(currentPageId) localStorage.setItem(STATE_KEY(currentPageId), JSON.stringify(state)); }

  function loadState(){
    const raw = localStorage.getItem(STATE_KEY(currentPageId));
    state = defState();
    if(raw){ try{ state = Object.assign(state, JSON.parse(raw)||{}); }catch{} }

    // UI
    els.tbody.innerHTML = "";
    if(state.items && state.items.length){ state.items.forEach(it=> addRow(it, false)); }
    els.delivery.value = state.delivery || 0;
    els.discount.value = state.discount || 0;
    if(state.currency!=='USD' && state.currency!=='LBP') state.currency='USD';
    els.currency.value = state.currency;

    applyLang(state.lang || 'ar');
    [...els.langSwitch.children].forEach(b=> b.classList.toggle('active', b.dataset.lang === state.lang));
    updateTotals();
  }

  function applyLang(l){
    state.lang = l;
    const t = texts[l];
    document.documentElement.dir = t.dir;
    document.documentElement.lang = l;
    $("#appTitle").textContent = t.appTitle;
    $("#hint").textContent = t.hint;
    $("#persistNote").textContent = `${t.persistNote} ثابت التحويل: 1 USD = 90000 LBP.`;
    $("#thImg").textContent = t.thImg; $("#thName").textContent = t.thName; $("#thUnit").textContent = t.thUnit;
    $("#thPrice").textContent = t.thPrice; $("#thQty").textContent = t.thQty; $("#thSub").textContent = t.thSub;
    $("#sumLabel").textContent = t.sumLabel; $("#discountLabel").textContent = t.discountLabel; $("#deliveryLabel").textContent = t.deliveryLabel;
    $("#grandLabel").textContent = t.grandLabel; $("#footerNote").textContent = t.footer;
    els.addRow.textContent = t.addItem; els.exportJSON.textContent = t.jsonExport; els.importJSON.textContent = t.jsonImport; els.clearAll.textContent = t.clearAll;
    els.pagesBtn.textContent = t.pagesBtn; els.pagesHint.textContent = t.pagesHint; els.pageAdd.textContent = t.pageNew; els.pageRename.textContent = t.rename;
    if(els.pageDelete) els.pageDelete.textContent = t.deletePage; // ← نص زر الحذف

    // placeholders
    $$("#itemsTable tbody tr").forEach(tr=>{
      tr.querySelector('.name').placeholder = t.phName;
      tr.querySelector('.unit').placeholder = t.phUnit;
      tr.querySelector('.price').placeholder = t.phPrice;
      tr.querySelector('.qty').placeholder = t.phQty;
      tr.querySelector('.rm').textContent = t.remove;
      tr.querySelector('.thumb-btn').textContent = t.addPhoto;
    });
    updateTotals(); save();
  }

  function addRow(item, pushToState=true){
    if(!item){ item = {id:uid(), name:"", unit:"", price:0, qty:0, imgData:null}; }
    if(pushToState){ state.items.push(item); }

    const tr = document.createElement('tr');
    tr.dataset.id = item.id;
    tr.innerHTML = `
      <td>
        <div class="thumb-uploader">
          <img alt="" src="${item.imgData ? item.imgData : ''}" style="display:${item.imgData ? 'block' : 'none'}">
          <label class="thumb-btn"></label>
          <input type="file" accept="image/*">
        </div>
      </td>
      <td><input class="name" type="text"></td>
      <td><input class="unit" type="text"></td>
      <td><input class="price" type="number" min="0" step="0.01"></td>
      <td><input class="qty" type="number" min="0" step="0.001"></td>
      <td class="subtotal">0</td>
      <td><button class="rm danger"></button></td>
    `;
    els.tbody.appendChild(tr);

    const t = texts[state.lang];
    tr.querySelector('.name').value = item.name; tr.querySelector('.name').placeholder = t.phName;
    tr.querySelector('.unit').value = item.unit; tr.querySelector('.unit').placeholder = t.phUnit;
    tr.querySelector('.price').value = item.price; tr.querySelector('.price').placeholder = t.phPrice;
    tr.querySelector('.qty').value = item.qty; tr.querySelector('.qty').placeholder = t.phQty;
    tr.querySelector('.rm').textContent = t.remove;
    tr.querySelector('.thumb-btn').textContent = t.addPhoto;

    const fileInput = tr.querySelector('input[type="file"]');
    const img = tr.querySelector('img');

    function sanitizeNum(v, d){ let n = parseFloat(v); if(!Number.isFinite(n) || n<0) n=0; return Number(n.toFixed(d)); }

    tr.querySelector('.name').addEventListener('input', e=>{ item.name = e.target.value; save(); });
    tr.querySelector('.unit').addEventListener('input', e=>{ item.unit = e.target.value; save(); });

    const priceEl = tr.querySelector('.price');
    const qtyEl   = tr.querySelector('.qty');

    priceEl.addEventListener('input', e=>{ const v=parseFloat(e.target.value); item.price=(!Number.isFinite(v)||v<0)?0:v; updateRow(tr,item); });
    qtyEl.addEventListener('input', e=>{ const v=parseFloat(e.target.value); item.qty=(!Number.isFinite(v)||v<0)?0:v; updateRow(tr,item); });

    priceEl.addEventListener('blur', e=>{ item.price = sanitizeNum(e.target.value, 2); e.target.value = item.price; updateRow(tr,item); });
    qtyEl.addEventListener('blur', e=>{ item.qty = sanitizeNum(e.target.value, 3); e.target.value = item.qty; updateRow(tr,item); });

    tr.querySelector('.rm').addEventListener('click', ()=>{ removeItem(item.id); });
    tr.querySelector('.thumb-btn').addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = e=>{ item.imgData = e.target.result; img.src = item.imgData; img.style.display='block'; save(); };
      reader.readAsDataURL(f);
    });

    updateRow(tr,item);
  }

  function rowSubtotal(item){
    if(!isNum(item.price) || item.price < 0) return 0;
    if(!isNum(item.qty)   || item.qty   < 0) return 0;
    return item.price * item.qty;
  }

  function updateRow(tr,item){
    const sub = rowSubtotal(item);
    tr.querySelector('.subtotal').textContent = formatMoney(sub);
    updateTotals(); save();
  }

  function removeItem(id){
    state.items = state.items.filter(x=>x.id!==id);
    const row = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
    if(row) row.remove();
    updateTotals(); save();
  }

  function updateTotals(){
    const sum = state.items.reduce((a,b)=> a + rowSubtotal(b), 0);
    const afterDiscount = sum * (1 - (+state.discount||0)/100);
    const grand = afterDiscount + (+state.delivery||0);
    els.sumVal.textContent = formatMoney(sum);
    els.grandVal.textContent = formatMoney(grand);
  }

  els.tbody.addEventListener('input', (e)=>{
    if(e.target.classList.contains('price') || e.target.classList.contains('qty')){ updateTotals(); save(); }
  });

  function convertAllPrices(from, to){
    if(from===to) return;
    const factor = RATES[to] / RATES[from];
    state.items.forEach(it=>{ it.price = Number(((+it.price||0) * factor).toFixed(2)); });
    $$("#itemsTable tbody tr").forEach((tr, idx)=>{
      const it = state.items[idx];
      tr.querySelector('.price').value = it.price;
      tr.querySelector('.subtotal').textContent = formatMoney(rowSubtotal(it));
    });
  }

  // events
  els.addRow.addEventListener('click', ()=> addRow(undefined, true));
  els.delivery.addEventListener('input', e=>{ state.delivery = Math.max(0, parseFloat(e.target.value)||0); updateTotals(); save(); });
  els.discount.addEventListener('input', e=>{ state.discount = Math.max(0, parseFloat(e.target.value)||0); updateTotals(); save(); });

  els.currency.addEventListener('change', e=>{
    const newCur = e.target.value, oldCur = state.currency;
    convertAllPrices(oldCur, newCur); state.currency = newCur; updateTotals(); save();
  });

  els.exportJSON.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `food-costing-${currentPageId}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  els.importJSON.addEventListener('click', ()=> els.jsonFile.click());
  els.jsonFile.addEventListener('change', ()=>{
    const f = els.jsonFile.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        if(!data || !Array.isArray(data.items)) throw new Error('invalid');
        state = Object.assign(defState(), data);
        els.tbody.innerHTML = ""; state.items.forEach(it=> addRow(it, false));
        els.delivery.value = state.delivery || 0; els.discount.value = state.discount || 0;
        if(state.currency!=='USD' && state.currency!=='LBP') state.currency='USD';
        els.currency.value = state.currency;
        applyLang(state.lang); updateTotals(); save();
      }catch(err){ alert('Failed to import JSON'); }
    };
    reader.readAsText(f);
  });

  els.clearAll.addEventListener('click', ()=>{
    const msg = state.lang==='ar'?'سيتم حذف بيانات هذه الصفحة فقط. متابعة؟':'This will clear this page only. Continue?';
    if(confirm(msg)){ state.items=[]; els.tbody.innerHTML=""; state.delivery=0; state.discount=0; els.delivery.value=0; els.discount.value=0; updateTotals(); save(); }
  });

  // اللغة
  els.langSwitch.addEventListener('click', (e)=>{
    if(e.target.tagName==='BUTTON'){
      [...els.langSwitch.children].forEach(b=> b.classList.remove('active'));
      e.target.classList.add('active'); applyLang(e.target.dataset.lang);
    }
  });

  // صفحات: فتح/إغلاق القائمة + أزرار
  els.pagesBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleDD(); });
  document.addEventListener('click', ()=> closeDD());
  els.pagesDD.addEventListener('click', (e)=> e.stopPropagation());
  els.pageAdd.addEventListener('click', addPage);
  els.pageRename.addEventListener('click', renamePage);
  els.pageDelete.addEventListener('click', deletePage); // ← تفعيل زر الحذف
  window.addEventListener('hashchange', ()=>{
    const m = ensureMeta();
    const idFromHash = (location.hash.match(/#p=([A-Za-z0-9_-]+)/)||[])[1];
    if(idFromHash && idFromHash!==m.activeId && m.list.some(p=>p.id===idFromHash)){ switchPage(idFromHash); }
  });

  // init
  $("#year").textContent = new Date().getFullYear();

  // جهّز الصفحات
  const meta0 = ensureMeta();
  const idFromHash = (location.hash.match(/#p=([A-Za-z0-9_-]+)/)||[])[1];
  if(idFromHash && meta0.list.some(p=>p.id===idFromHash)) meta0.activeId = idFromHash;
  saveMeta(meta0);
  currentPageId = meta0.activeId; setHash(currentPageId);
  renderPagesDD();
  setActivePageName(); // اسم الصفحة عند الإقلاع
  loadState();
})();
</script>
</body>
</html>
